# 虚拟化<a name="ZH-CN_TOPIC_0185681960"></a>

## Qemu<a name="section14349202621712"></a>

openEuler 1.0 中配套 Qemu 为 4.0.0 版本，相比早期版本修复了诸多缺陷并进行了特性和设备支持能力的增强，重要更新如下：

**特性增强**

-   热迁移postcopy支持hugpages和hugtlbfs
-   支持GICv3 KVM的热迁移
-   热迁移Postcopy支持限速，支持migrate\_pause,支持migrate\_recover
-   虚拟机内呈现CPU frequency（GuestOS 需要4.19以及更高版本内核）
-   虚拟机内部呈现CPU Mode
-   热迁移时内存压缩，缩短迁移时长

**设备支持**

-   PCI/PCIe：支持新的pcie-root-port设备，新的virt类型主板默认disable了PCIe-to-PCI-bridge上的SHPC，默认使用ACPI热插拔
-   支持了SMMUv3模拟（soft-iommu\)
-   virt类型主板开始支持512CPUs
-   将ECMA Region扩大到256M，支持更多的PCI设备
-   New CPU model: Cortex-A72
-   Virt4.0 guest machine type 支持超过1TB RAM

**性能优化**

-   I/O线程性能优化，多磁盘并发读写场景下提升10%-20%

## KVM<a name="section2663102117408"></a>

在4.1.9内核KVM版本基础上进行bug修复、社区新特性回合和自研能力增强，重点能力如下：

**虚拟机动态IPA**

低版本KVM仅支持40位固定的IPA，openEuler 1.0 通过修改Stage2页表的分级、布局，支持用户态配置动态的IPA位数，理论上，可以支持最多48位IPA，从而可以支持更大的虚拟机内存规格。

**Stage2 1G大页支持**

通过修改Stage2缺页异常处理逻辑，支持Stage2 1G大页。

**虚拟机中Perf性能统计支持ARM架构**

支持命令“perf kvm stat record/report”，在虚拟机或vcpu粒度统计exit、trap的类型、次数和时间。

**iscsi kworker自适应IO性能提升**

iscsi默认创建的order workqueue调度范围是全cpu，当其与对应网卡中断不在相同的numa node时会导致性能下降，通过新增flag控制其创建workqueue在指定对应的numa node运行，通过跟随对应的网卡中断保持同numa node，提升ipsan 访问IO性能。

**IRQfd路径注入中断优化**

优化通过IRQfd路径注入的中断，降低vhost-user、vhost-net、GICv3+直通设备（网卡、磁盘）等场景下CPU资源消耗30%。

## Open vSwitch<a name="section562416012180"></a>

openEuler 1.0 中配套的 Open vSwitch 为开源社区的 2.11.1 版本，仅进行了 openEuler 的内核版本适配。

