# 打包说明<a name="ZH-CN_TOPIC_0184337290"></a>

## 原理介绍<a name="section59131015104613"></a>

RPM打包的时候需要编译源码，需要把编译好的配置文件、二进制命令文件等放到合适的位置，还要根据需要对RPM的包进行测试，这些都需要先有一个“工作空间”。rpmbuild命令使用一套标准化的“工作空间”：

```
$ rpmdev-setuptree
```

rpmdev-setuptree这个命令就是安装 rpmdevtools 带来的。可以看到运行了这个命令之后，在$HOME家目录下多了一个叫做 rpmbuild 的文件夹，里边内容如下：

```
$ tree rpmbuild
rpmbuild
|-- BUILD
|-- BUILDROOT
|-- RPMS
|-- SOURCES
|-- SPECS
`-- SRPMS
```

内容相关的说明如下：

<a name="table1268115913017"></a>
<table><thead align="left"><tr id="row673319549321"><th class="cellrowborder" valign="top" width="27.1%" id="mcps1.1.5.1.1"><p id="p1673485453210"><a name="p1673485453210"></a><a name="p1673485453210"></a><strong id="b215284143812"><a name="b215284143812"></a><a name="b215284143812"></a>目录</strong></p>
</th>
<th class="cellrowborder" valign="top" width="18.38%" id="mcps1.1.5.1.2"><p id="p167341354193219"><a name="p167341354193219"></a><a name="p167341354193219"></a><strong id="b151541483812"><a name="b151541483812"></a><a name="b151541483812"></a>宏代码</strong></p>
</th>
<th class="cellrowborder" valign="top" width="17.76%" id="mcps1.1.5.1.3"><p id="p157341854103211"><a name="p157341854103211"></a><a name="p157341854103211"></a><strong id="b121547463819"><a name="b121547463819"></a><a name="b121547463819"></a>名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="36.76%" id="mcps1.1.5.1.4"><p id="p1273465410328"><a name="p1273465410328"></a><a name="p1273465410328"></a><strong id="b191551414388"><a name="b191551414388"></a><a name="b191551414388"></a>功能</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row107541059163020"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p675425913015"><a name="p675425913015"></a><a name="p675425913015"></a>~/rpmbuild/BUILD</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p175405917305"><a name="p175405917305"></a><a name="p175405917305"></a>%_builddir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p1754175903010"><a name="p1754175903010"></a><a name="p1754175903010"></a>构建目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p875415916306"><a name="p875415916306"></a><a name="p875415916306"></a>源码包被解压至此，并在该目录的子目录完成编译</p>
</td>
</tr>
<tr id="row19754195903010"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p167541759193019"><a name="p167541759193019"></a><a name="p167541759193019"></a>~/rpmbuild/BUILDROOT</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p37544598306"><a name="p37544598306"></a><a name="p37544598306"></a>%_buildrootdir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p13754175911301"><a name="p13754175911301"></a><a name="p13754175911301"></a>最终安装目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p19754145919303"><a name="p19754145919303"></a><a name="p19754145919303"></a>保存 %install 阶段安装的文件</p>
</td>
</tr>
<tr id="row117541859183017"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p87541259163017"><a name="p87541259163017"></a><a name="p87541259163017"></a>~/rpmbuild/RPMS</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p9754125913018"><a name="p9754125913018"></a><a name="p9754125913018"></a>%_rpmdir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p12754205963018"><a name="p12754205963018"></a><a name="p12754205963018"></a>标准 RPM 包目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p177548599306"><a name="p177548599306"></a><a name="p177548599306"></a>生成/保存二进制 RPM 包</p>
</td>
</tr>
<tr id="row88505117359"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p3753759173019"><a name="p3753759173019"></a><a name="p3753759173019"></a>~/rpmbuild/SOURCES</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p9753185903013"><a name="p9753185903013"></a><a name="p9753185903013"></a>%_sourcedir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p10753135913308"><a name="p10753135913308"></a><a name="p10753135913308"></a>源代码目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p675495933018"><a name="p675495933018"></a><a name="p675495933018"></a>保存源码包（如 .tar 包）和所有 patch 补丁</p>
</td>
</tr>
<tr id="row1868513113357"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p3753135912308"><a name="p3753135912308"></a><a name="p3753135912308"></a>~/rpmbuild/SPECS</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p147534598305"><a name="p147534598305"></a><a name="p147534598305"></a>%_specdir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p17753105910308"><a name="p17753105910308"></a><a name="p17753105910308"></a>Spec 文件目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p4753125918302"><a name="p4753125918302"></a><a name="p4753125918302"></a>保存 RPM 包配置（.spec）文件</p>
</td>
</tr>
<tr id="row275418594301"><td class="cellrowborder" valign="top" width="27.1%" headers="mcps1.1.5.1.1 "><p id="p9754115973018"><a name="p9754115973018"></a><a name="p9754115973018"></a>~/rpmbuild/SRPMS</p>
</td>
<td class="cellrowborder" valign="top" width="18.38%" headers="mcps1.1.5.1.2 "><p id="p14754559163011"><a name="p14754559163011"></a><a name="p14754559163011"></a>%_srcrpmdir</p>
</td>
<td class="cellrowborder" valign="top" width="17.76%" headers="mcps1.1.5.1.3 "><p id="p7754115923010"><a name="p7754115923010"></a><a name="p7754115923010"></a>源代码 RPM 包目录</p>
</td>
<td class="cellrowborder" valign="top" width="36.76%" headers="mcps1.1.5.1.4 "><p id="p10754165933017"><a name="p10754165933017"></a><a name="p10754165933017"></a>生成/保存源码 RPM 包(SRPM)</p>
</td>
</tr>
</tbody>
</table>

SPECS 下是RPM包的配置文件，是RPM打包的“图纸”，这个文件会告诉rpmbuild命令如何去打包。“宏代码”这一列就可以在SPEC文件中用来代指所对应的目录，类似于编程语言中的宏或全局变量。

## 打包流程<a name="section031173612466"></a>

打包的过程主要分为如下步骤：

1.  把源代码放到%\_sourcedir中。
2.  进行编译，编译的过程是在%\_builddir中完成的，一般情况下，源代码是压缩包格式，需要先进行解压。
3.  进行“安装”，类似于预先组装软件包，把软件包应该包含的内容（比如二进制文件、配置文件、man文档等）复制到%\_buildrootdir中，并按照实际安装后的目录结构组装，比如二进制命令可能会放在/usr/bin下，那么就在%\_buildrootdir下也按照同样的目录结构放置。
4.  做一些必要的配置，比如在实际安装前的准备，安装后的清理等等。这些都是通过配置在SPEC文件中来告诉rpmbuild命令。
5.  检查软件是否正常运行。
6.  生成的RPM包放置到%\_rpmdir，源码包放置到%\_srpmdir下。

在SPEC文件中的，各个阶段说明如下：

<a name="table14621920105410"></a>
<table><thead align="left"><tr id="row1416062025411"><th class="cellrowborder" valign="top" width="7.75077507750775%" id="mcps1.1.5.1.1"><p id="p141601200544"><a name="p141601200544"></a><a name="p141601200544"></a><strong id="b18160102005415"><a name="b18160102005415"></a><a name="b18160102005415"></a><span>阶段</span></strong></p>
</th>
<th class="cellrowborder" valign="top" width="13.931393139313933%" id="mcps1.1.5.1.2"><p id="p8160122017546"><a name="p8160122017546"></a><a name="p8160122017546"></a><strong id="b2016052095418"><a name="b2016052095418"></a><a name="b2016052095418"></a><span>读取的目录</span></strong></p>
</th>
<th class="cellrowborder" valign="top" width="10.391039103910392%" id="mcps1.1.5.1.3"><p id="p816015207540"><a name="p816015207540"></a><a name="p816015207540"></a><strong id="b18160920145418"><a name="b18160920145418"></a><a name="b18160920145418"></a><span>写入的目录</span></strong></p>
</th>
<th class="cellrowborder" valign="top" width="67.92679267926793%" id="mcps1.1.5.1.4"><p id="p1016072017548"><a name="p1016072017548"></a><a name="p1016072017548"></a><strong id="b1116032015420"><a name="b1116032015420"></a><a name="b1116032015420"></a><span>具体动作</span></strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row13160102085419"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p2160152017546"><a name="p2160152017546"></a><a name="p2160152017546"></a><span>%prep</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p16160122010543"><a name="p16160122010543"></a><a name="p16160122010543"></a><span>%_sourcedir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p71609207547"><a name="p71609207547"></a><a name="p71609207547"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p1716017206546"><a name="p1716017206546"></a><a name="p1716017206546"></a><span>读取位于</span> <span>%_sourcedir</span> <span>目录的源代码和</span><span> patch </span><span>。之后，解压源代码至</span> <span>%_builddir</span> <span>的子目录并应用所有</span><span> patch</span><span>。</span></p>
</td>
</tr>
<tr id="row14161122015418"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p13161172012545"><a name="p13161172012545"></a><a name="p13161172012545"></a><span>%build</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p1416132055420"><a name="p1416132055420"></a><a name="p1416132055420"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p1116182015544"><a name="p1116182015544"></a><a name="p1116182015544"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p1216122017542"><a name="p1216122017542"></a><a name="p1216122017542"></a><span>编译位于</span> <span>%_builddir</span> <span>构建目录下的文件。通过执行类似</span> <span>./configure </span><span>&amp;</span><span>&amp;</span><span> make</span> <span>的命令实现。</span></p>
</td>
</tr>
<tr id="row9161320155419"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p916162025419"><a name="p916162025419"></a><a name="p916162025419"></a><span>%install</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p13161720135415"><a name="p13161720135415"></a><a name="p13161720135415"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p13161192085414"><a name="p13161192085414"></a><a name="p13161192085414"></a><span>%_buildrootdir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p1216162011546"><a name="p1216162011546"></a><a name="p1216162011546"></a><span>读取位于</span> <span>%_builddir</span> <span>构建目录下的文件并将其安装至</span> <span>%_buildrootdir</span> <span>目录。这些文件就是用户安装</span><span> RPM </span><span>后，最终得到的文件。</span></p>
</td>
</tr>
<tr id="row5161172035417"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p2161132065410"><a name="p2161132065410"></a><a name="p2161132065410"></a><span>%check</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p4161162010548"><a name="p4161162010548"></a><a name="p4161162010548"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p18161202019544"><a name="p18161202019544"></a><a name="p18161202019544"></a><span>%_builddir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p15161152013541"><a name="p15161152013541"></a><a name="p15161152013541"></a><span>检查软件是否正常运行。通过执行类似</span> <span>make test</span> <span>的命令实现。</span></p>
</td>
</tr>
<tr id="row19161202035419"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p111617208547"><a name="p111617208547"></a><a name="p111617208547"></a><span>bin</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p161613204544"><a name="p161613204544"></a><a name="p161613204544"></a><span>%_buildrootdir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p141611120175410"><a name="p141611120175410"></a><a name="p141611120175410"></a><span>%_rpmdir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p12161162018541"><a name="p12161162018541"></a><a name="p12161162018541"></a><span>读取位于</span> <span>%_buildrootdir</span> <span>最终安装目录下的文件，以便最终在</span> <span>%_rpmdir</span> <span>目录下创建</span><span> RPM </span><span>包。在该目录下，不同架构的</span><span> RPM </span><span>包会分别保存至不同子目录，</span> <span>noarch</span> <span>目录保存适用于所有架构的</span><span> RPM </span><span>包。这些</span><span> RPM </span><span>文件就是用户最终安装的</span><span> RPM </span><span>包。</span></p>
</td>
</tr>
<tr id="row416213208540"><td class="cellrowborder" valign="top" width="7.75077507750775%" headers="mcps1.1.5.1.1 "><p id="p1416262085419"><a name="p1416262085419"></a><a name="p1416262085419"></a><span>src</span></p>
</td>
<td class="cellrowborder" valign="top" width="13.931393139313933%" headers="mcps1.1.5.1.2 "><p id="p716282015541"><a name="p716282015541"></a><a name="p716282015541"></a><span>%_sourcedir</span></p>
</td>
<td class="cellrowborder" valign="top" width="10.391039103910392%" headers="mcps1.1.5.1.3 "><p id="p17162142010547"><a name="p17162142010547"></a><a name="p17162142010547"></a><span>%_srcrpmdir</span></p>
</td>
<td class="cellrowborder" valign="top" width="67.92679267926793%" headers="mcps1.1.5.1.4 "><p id="p2162182011543"><a name="p2162182011543"></a><a name="p2162182011543"></a><span>创建源码</span><span> RPM </span><span>包（简称</span><span> SRPM</span><span>，以</span><span>.src.rpm</span> <span>作为后缀名），并保存至</span> <span>%_srcrpmdir</span> <span>目录。</span><span>SRPM </span><span>包通常用于审核和升级软件包。</span></p>
</td>
</tr>
</tbody>
</table>

