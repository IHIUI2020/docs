# 注意事项<a name="ZH-CN_TOPIC_0184808220"></a>

-   在热升级过程中，docker daemon不响应外部API，所有对docker daemon的访问都会返回失败或者卡住，同时docker daemon的进程也会停止，因此如果有心跳机制检测docker daemon的健康状态，在热升级过程中需要停止。
-   升级完毕后系统会自动重启docker daemon服务，视当前系统负载情况，docker daemon的服务可能会中断几十秒到几分钟。
-   必须在daemon的启动参数中加上--live-restore，使能该功能后，重启/停止daemon不会使正在运行中的容器自动停止；如果停止daemon时要把所有容器都停止，则需要在停止前执行：

    ```
     docker stop $(docker ps -q)
    ```

-   要使用热升级功能时，用户的自定义参数要放在/etc/docker/daemon.json文件中，比如devicemapper的相关配置，如果是放在/etc/sysconfig/docker中，那么在升级的时候会被覆盖的，必须在升级完后重新配置/etc/sysconfig/docker。

    ```
    {
        "storage-opts":[
            "dm.datadev=/dev/mapper/vg--docker-data",
            "dm.metadatadev=/dev/mapper/vg--docker-metadata",
            "dm.fs=ext4",
            "dm.use_deferred_removal=true",
            "dm.use_deferred_deletion=true"
        ]
    }
    ```

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >注意：配置参数放在/etc/docker/daemon.json后，docker daemon的进程的参数是看不到这几个配置参数的。  

-   如果容器的网络是使用的外部插件，那么在热升级过程中，插件需要保持运行状态或者插件再次启动后能恢复原来容器的一些网络状态，比如分配给容器的ip地址等。使用docker自带的网络插件无此限制。
-   容器的stdio是通过fifo传输的，fifo的buffer大小为1M（每个发行版本可能不一样，Euler OS上为1M），在升级过程中，日志都是缓存在fifo中的，在升级过程中，如果日志缓存超过1M，容器将block住，因此热升级过程中需要保证容器日志不会超出1M，如果明确有容器的日志可能超过1M大小，则可以通过修改/proc/sys/fs/pipe-max-size来增加buffer的大小。
-   在热升级过程中userland-proxy（容器有端口映射时会启动一个userland-proxy）会跟随着daemom一起挂掉，daemon再次启动后会启动一个新的userland-proxy，userland-proxy的作用上是转发主机127.0.0.1的流量到容器内部，因此如果有业务依赖是通过主机的127.0.0.1来访问容器时，会导致短暂的中断。不建议docker开启userland-proxy，它可能会引发一些系统问题，如内存泄露，触发内核bug等，建议在daemon的启动参数中加上--userland-proxy=false，业务不要通过主机127.0.0.1地址来访问到容器内部。
-   如果容器设置了重启规则并且在升级过程中容器卡死，容器重启规则不会起作用，只有daemon再次启动的时候，重启规则会重新起作用。升级后容器的重启次数会丢失，如果有容器设置了--restart on-failure:N，每次升级后重启次数会重新计算。
-   用systemd启动docker daemon的时候，不能在docker.service文件中加上MountFlags=slave。
-   禁止在同版本之间进行热升级。

